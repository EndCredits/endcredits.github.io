import{_ as l,p as c,q as s,v as t,s as e,G as a,t as n,J as i,n as r}from"./framework-94166e2f.js";const o={},p=e("p",null,"为自己的 Redmi K30 5G 编译一个 Linux 内核吧~ | 顺便记录一下自己编译内核的历程",-1),u=i(`<h2 id="_1-系统软件包" tabindex="-1"><a class="header-anchor" href="#_1-系统软件包" aria-hidden="true">#</a> 1.系统软件包</h2><p>不同的系统需要不同的软件包，其实下面的软件包已经足以支撑整个 AOSP 的编译，</p><ol><li><p>Ubuntu/Debian 系:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>sudo apt-get install git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>REHL/CentOS/Alma/Rocky/Fedora 系:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>dnf install @development-tools android-tools automake bison bzip2 bzip2-libs ccache curl dpkg-dev gcc gcc-c++ gperf libstdc++.i686 libxml2-devel lz4-libs lzop make maven ncurses-compat-libs openssl-devel pngcrush python python3 python3-mako python-mako python-networkx schedtool squashfs-tools syslinux-devel zip zlib-devel zlib-devel.i686 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>openSUSE 系:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>sudo zypper install bison curl flex git gnupg gperf libesd-devel liblz4-1 ncurses-devel libSDL-devel python-wxWi dgets-devel libxml2-2 libxml2-tools lzop  schedtool squashfs libxslt1 zip zlib-devel make gcc-c++ glibc-devel-32bit ncurses-devel-32bit readline-devel-32bit libz1-32bit &amp;&amp; sudo zypper install --type pattern devel_basis
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>Arch 系:</p><p>如果直接使用 AUR 中提供的 <code>aosp-devel</code> 包和 <code>lineageos-devel</code> 包将会非常方便 (下面使用 yay 作为示例)</p><p>注意 您必须启用 <code>multilib</code> 仓库</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>yay -S lineageos-devel
sudo pacman -S libxcrypt-compat lib32-libxcrypt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Gentoo/LFS 等用户</p><p>我相信你们已经拥有了自己找软件包的能力，嗯</p></li></ol><h2 id="_2-交叉编译工具链" tabindex="-1"><a class="header-anchor" href="#_2-交叉编译工具链" aria-hidden="true">#</a> 2. 交叉编译工具链</h2><p>众所周知，咱们的电脑是 x86 架构的，如果直接按照 x86 指令集进行编译，那么身为 arm 阵营的手机是理解不了我们编译的内核的，所以我们就需要<code>交叉编译</code>这个工具来帮助电脑把他的语言&quot;翻译&quot;成我们的手机可以理解的的语言</p><p>我们根据 Google 的行为，选择 <code>clang</code> 作为我们的交叉编译工具链，这里我们使用我编译的 <code>crepuscular clang</code> ，或者你也可以使用 <code>proton clang</code> 等等，大同小异</p><p>首先下载 clang :</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>mkdir -p ~/toolchains #或者换成任意你想要把 clang 放在那里的地方

git clone https://gitlab.com/EndCredits/clang-crepuscular.git --depth=1 ~/toolchains/clang-crepuscular #记得要跟上面一样的目录
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后为 clang 添加环境变量</p><p>将以下内容添加到 <code>~/.bashrc</code> 或者 <code>~/.zshrc</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>PATH=~/toolchains/clang-crepuscular/bin:$PATH
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>验证一下我们成功了没有，运行结果里有 crepuscular 就好啦</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>clang --version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>到这里系统的准备工作就结束啦</p><h2 id="_3-准备内核源码并编译" tabindex="-1"><a class="header-anchor" href="#_3-准备内核源码并编译" aria-hidden="true">#</a> 3. 准备内核源码并编译</h2><p>这里我们使用我修改过的内核源码，从 Github 上 clone</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>git clone https://github.com/EndCredits/android_kernel_xiaomi_sm7250.git -b 12.0-main ~/kernel/sm7250
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>因为我的内核内置了编译脚本，所以可以直接用，其实别的支持打包 dtbo 的 4.19 内核里这个脚本也可以用，只不过需要改一下 defconfig 的名字</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>cd ~/kernel/sm7250
./build.sh all
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>编译完成之后就可以获得一个可以刷入的内核包啦</p><h2 id="_4-手动编译" tabindex="-1"><a class="header-anchor" href="#_4-手动编译" aria-hidden="true">#</a> 4. 手动编译</h2><p>其实上面的编译脚本就是把下面这些命令一股脑扔了进去</p><p>首先我们进入到内核的源码目录</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>cd ~/kernel/sm7250
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后我们会用到 <code>make</code> 这个工具，首先我们来告诉编译系统需要往我们的内核里编译什么东西，也就是 <code>defconfig</code> ，如前文所言，这个文件描述了我们的内核里有什么功能，每个机型一般都不一样，你需要找到自己机型对应的配置文件，对于现在的 arm64 机型来说，它一般放置在 <code>arch/arm64/configs/</code> 下，我们 <code>picasso</code> 默认的 <code>defconfig</code> 是 <code>arch/arm64/configs/vendor/picasso_user_defconfig</code> ，我们略去前面复杂的路径 (因为 <code>ARCH=arm64</code> 已经告诉了 <code>make</code> 应该到 <code>arm64</code> 文件夹中来找这个文件)</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>make ARCH=arm64 LLVM=1 O=../out -j$(nproc --all) vendor/picasso_user_defconfig
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>上面的命令中，<code>LLVM=1</code> 的作用是启用 <code>LLVM/clang</code> 工具链作为我们的内核编译工具，不然它默认会去寻找 <code>gcc</code> 作为编译工具，<code>-j$(nproc --all)</code> 是告诉编译系统使用所有 CPU 线程并行编译，<code>-j</code>参数后面给出的数字就是你想要同时使用的 CPU 线程数</p><p>如果你想要改变编译进内核的东西，你可以使用 <code>menuconfig</code> 来调整这个文件</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>make ARCH=arm64 LLVM=1 O=../out -j$(nproc --all) menuconfig
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>它会为你打开一个非常漂亮的界面，你可以选择启用或者关闭各项内核的功能，如果没有这方面的需求，直接用默认的就好，然后就可以编译内核啦</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>make ARCH=arm64 LLVM=1 CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- CLANG_TRIPLE=aarch64-linux-gnu- O=../out -j$(nproc --all)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>等上一会，内核的编译就完成啦，不过这时候我们得到的内核还只是一个 <code>Image</code>，我们还需要 <code>AnyKernel</code> 来帮助我们把它刷入手机</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>cd ../out/arch/arm64/boot
git clone https://github.com/EndCredits/AnyKernel3 -b picasso anykernel
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的 <code>anykernel</code> 是修改过的，只适用于 <code>picasso</code>，如果你想给你的手机也制作一份的话，可以参考这里:</p>`,34),m={href:"https://github.com/EndCredits/AnyKernel3/commit/ab7be4efcf3b4d11ec33728501d361f63823d393",target:"_blank",rel:"noopener noreferrer"},v={href:"https://github.com/EndCredits/AnyKernel3/commit/ca166c32e3b98990b4747c446a7252ca6d760460",target:"_blank",rel:"noopener noreferrer"},b=i(`<p>然后我们把所有的 dtb 文件都连接成一个，方便我们刷入</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>find ./dts/vendor/qcom -name &#39;*.dtb&#39; -exec cat {} + &gt; ./dtb;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后就可以开始打包啦</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>cp Image ./anykernel/ &amp;&amp; cp dtb ./anykernel/ &amp;&amp; cp dtbo.img ./anykernel/

zip -q -r Kernel-$(date &#39;+%Z-%Y-%m-%d-%H%M&#39;)-$(make kernelversion)-.zip ./anykernel/*
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样，内核的打包就到此结束，把上面得到的压缩文件放入手机，就可以愉快的刷入啦</p><hr>`,6);function g(x,h){const d=r("ExternalLinkIcon");return c(),s("div",null,[p,t(" More "),u,e("p",null,[e("a",m,[a("ab7be4efcf anykernel: Adapt to Rosemary kernel for tiffany."),n(d)])]),e("p",null,[e("a",v,[a("ca166c32e3 adapt to picasso"),n(d)])]),b])}const _=l(o,[["render",g],["__file","build-kernel.html.vue"]]);export{_ as default};
