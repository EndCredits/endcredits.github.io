import{_ as l,p as o,q as r,s as a,G as s,t as e,J as p,n as t}from"./framework-e6265383.js";const i={},c={href:"https://www.bilibili.com/video/BV1Gm4y1h7W6/",target:"_blank",rel:"noopener noreferrer"},d=a("p",null,"本文假设您拥有最基本的 Linux 操作知识以及科学上网的能力",-1),u=a("h2",{id:"环境的配置",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#环境的配置","aria-hidden":"true"},"#"),s(" 环境的配置")],-1),v=a("p",null,"准备好可以编译的内核源码",-1),b=a("p",null,"这里为 renoir 编译，就使用我自己的源码吧",-1),m={href:"https://github.com/EndCredits/android_kernel_xiaomi_sm8350",target:"_blank",rel:"noopener noreferrer"},k=a("p",null,"为避免发行版差异造成的配置失败，这里使用 Docker 来简化环境搭建",-1),h={href:"https://github.com/EndCredits/Docker_Build_AOSP",target:"_blank",rel:"noopener noreferrer"},g=p(`<p>为方便说明，以下所有需要传入的路径均为绝对路径</p><p>前面的都照着项目里的 README 来就好，从路径配置开始 稍微与 README 有点差别</p><p>见下面的指令</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Host 中执行</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CLANG_PATH</span><span class="token operator">=</span><span class="token operator">&lt;</span>path to your clang<span class="token operator">&gt;</span> <span class="token comment"># 你 Clang 放置的位置</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>如果是使用 fish 的话，需要用 set 指令来设置环境变量</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Host 中执行</span>
<span class="token builtin class-name">set</span> CLANG_PATH <span class="token operator">&lt;</span>path to your clang<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Host 中执行</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">KERNEL_SRC</span><span class="token operator">=</span><span class="token operator">&lt;</span>path to your kernel source<span class="token operator">&gt;</span> // 你内核源码树的位置
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后就可以运行 Docker 容器了</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Host 中执行</span>
<span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--rm</span> <span class="token parameter variable">-v</span> <span class="token variable">$CLANG_PATH</span>:/toolchains <span class="token parameter variable">-v</span> <span class="token variable">$KERNEL_SRC</span>:/kernel android-build-host
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>配置 Clang :</p><p>可以从镜像站或者 Android Source 获取 clang-google</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">git</span> clone https://mirrors.bfsu.edu.cn/git/AOSP/platform/prebuilts/clang/host/linux-x86/ clang-google <span class="token parameter variable">--depth</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>下面把 clang 添加入环境变量</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Docker 容器中执行</span>
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token operator">&lt;</span>path to your clang executable<span class="token operator">&gt;</span>:<span class="token environment constant">$PATH</span>

<span class="token comment">## 如果用 fish 的话可以用 fish_add_path 函数，但是 Docker 镜像里默认没有集成 fish ，一般来说直接用 bash 就好，命令都可以直接复制粘贴</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>建议所有 4.9 版本以上的内核都用 clang 来编译</p><h2 id="开始编译" tabindex="-1"><a class="header-anchor" href="#开始编译" aria-hidden="true">#</a> 开始编译</h2><p>解析编译参数</p><p><code>ARCH=arm64</code> : 设定目标架构是 arm64</p><p><code>LLVM=1</code> : 指定使用 LLVM 工具链</p><p><code>CROSS_COMPILE</code> : 指定使用的交叉编译工具链前缀</p><p><code>CROSS_COMPILE_COMPAT</code> : 制定使用的 32 位交叉编译工具链 ( vsdo 会用到 ), 如果你的内核版本低于 4.19 的话，这个参数应该叫 <code>CROSS_COMPILE_ARM32</code></p><p><code>CLANG_TRIPLE</code> = : 使用 AOSP Clang 时会用到</p><p><code>O</code> : 指定输出目录</p><p><code>-j(nproc --all)</code> : 使用全部线程编译</p><p>首先编译内核的配置文件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Docker 容器中执行</span>

<span class="token builtin class-name">cd</span> /kernel

<span class="token function">make</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>arm64 <span class="token assign-left variable">LLVM</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span>aarch64-linux-gnu- <span class="token assign-left variable">CROSS_COMPILE_COMPAT</span><span class="token operator">=</span>arm-linux-gnueabi- <span class="token assign-left variable">CLANG_TRIPLE</span><span class="token operator">=</span>aarch64-linux-gnu- <span class="token assign-left variable">O</span><span class="token operator">=</span>out -j<span class="token variable"><span class="token variable">$(</span>nproc <span class="token parameter variable">--all</span><span class="token variable">)</span></span> vendor/lahaina-qgki_defconfig vendor/xiaomi_QGKI.config vendor/renoir_QGKI.config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个是因人而异的，不同设备的内核配置文件也不一样，比如我的 picasso 就跟这个 renoir 不同</p><p>然后就可以开始编译了</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Docker 中执行</span>
<span class="token function">make</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>arm64 <span class="token assign-left variable">LLVM</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span>aarch64-linux-gnu- <span class="token assign-left variable">CROSS_COMPILE_COMPAT</span><span class="token operator">=</span>arm-linux-gnueabi- <span class="token assign-left variable">CLANG_TRIPLE</span><span class="token operator">=</span>aarch64-linux-gnu- <span class="token assign-left variable">O</span><span class="token operator">=</span>out -j<span class="token variable"><span class="token variable">$(</span>nproc <span class="token parameter variable">--all</span><span class="token variable">)</span></span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>静待编译完成</p>`,30);function _(f,C){const n=t("ExternalLinkIcon");return o(),r("div",null,[a("p",null,[s("简易内核编译教程，请与 bilibili 视频配套使用 "),a("a",c,[s("Click me!"),e(n)])]),d,u,v,b,a("p",null,[a("a",m,[s("EndCredits/android_kernel_xiaomi_sm8350"),e(n)])]),k,a("p",null,[s("这里是项目地址 "),a("a",h,[s("EndCredits/Docker_Build_AOSP"),e(n)])]),g])}const L=l(i,[["render",_],["__file","kernelbuild.html.vue"]]);export{L as default};
